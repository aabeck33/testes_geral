SELECT DR.CDDOCUMENT,CT.IDCATEGORY,DR.IDDOCUMENT,DR.NMTITLE,GR.IDREVISION,GNO.CDACTIONOBJECT,GNO.QTVALIDITY,GNO.DTVALIDITY,CAST (CASE WHEN GNO.FGSTATUS=1 THEN '#{103645}' WHEN GNO.FGSTATUS=2 THEN '#{100263}' WHEN GNO.FGSTATUS=3 THEN '#{101237}' END AS VARCHAR(255)) AS NMSTATUS_REVALID FROM DCDOCREVISION DR INNER JOIN DCDOCUMENT DC ON DC.CDDOCUMENT=DR.CDDOCUMENT INNER JOIN DCCATEGORY CT ON DR.CDCATEGORY=CT.CDCATEGORY INNER JOIN GNREVISION GR ON GR.CDREVISION=DR.CDREVISION INNER JOIN GNACTIONASSOC GNA ON GNA.CDACTIONASSOC=GR.CDACTIONASSOC INNER JOIN GNACTIONLIST GNL ON GNA.CDACTIONASSOC=GNL.CDACTIONASSOC INNER JOIN GNACTIONOBJECT GNO ON GNO.CDACTIONOBJECT=GNL.CDACTIONOBJECT LEFT OUTER JOIN GNREVISIONSTATUS GNST ON (GR.CDREVISIONSTATUS=GNST.CDREVISIONSTATUS) WHERE 1=1 AND DC.FGSTATUS IN ('1','2','3','5') AND CT.CDCATEGORY IN ('216','218','222','223','224','228','231','234','237','240','241','256','261','326','361','370','420','421','422','375','362','363','327','328','329','257','258','259','260','330','331','238','239','235','236','232','233','229','230','225','226','227','243','219','220','221') AND EXISTS (SELECT 1 FROM/*sub*/ GNUSERPERMTYPEROLE PM INNER JOIN DCCATEGORY CATEG ON PM.CDTYPEROLE=CATEG.CDTYPEROLE WHERE PM.CDUSER=1072 AND CT.CDCATEGORY=CATEG.CDCATEGORY AND PM.CDPERMISSION=5 AND PM.FGPERMISSIONTYPE=1 /* sub */UNION ALL SELECT 1 FROM/*sub*/ GNUSERPERMTYPEROLE PM INNER JOIN DCCATEGORY CATEG ON PM.CDTYPEROLE=CATEG.CDTYPEROLE WHERE PM.CDUSER=-1 AND CT.CDCATEGORY=CATEG.CDCATEGORY AND PM.CDPERMISSION=5 AND PM.FGPERMISSIONTYPE=1 /* sub */UNION ALL SELECT 1 FROM/*sub*/ DCCATEGORY CATEG WHERE CATEG.CDTYPEROLE IS NULL AND CT.CDCATEGORY=CATEG.CDCATEGORY) AND NOT EXISTS (SELECT 1 FROM/*sub*/ GNUSERPERMTYPEROLE PM INNER JOIN DCCATEGORY CATEG ON PM.CDTYPEROLE=CATEG.CDTYPEROLE WHERE PM.CDUSER=1072 AND CT.CDCATEGORY=CATEG.CDCATEGORY AND PM.CDPERMISSION=5 AND PM.FGPERMISSIONTYPE=2 /* sub */UNION ALL SELECT 1 FROM/*sub*/ GNUSERPERMTYPEROLE PM INNER JOIN DCCATEGORY CATEG ON PM.CDTYPEROLE=CATEG.CDTYPEROLE WHERE PM.CDUSER=-1 AND CT.CDCATEGORY=CATEG.CDCATEGORY AND PM.CDPERMISSION=5 AND PM.FGPERMISSIONTYPE=2) AND EXISTS (SELECT 1 FROM (SELECT DDOC.CDPERMISSION FROM DCUSERPERMISSIONDOC DDOC WHERE DDOC.CDUSER IN (1072, -1) AND DDOC.CDPERMISSION IN (3) AND DDOC.CDDOCUMENT=DC.CDDOCUMENT AND DDOC.FGPERMISSIONTYPE=1 /* sub */UNION ALL SELECT PC.CDPERMISSION FROM DCUSERPERMISSIONCATEG PC WHERE PC.CDUSER IN (1072, -1) AND PC.CDPERMISSION IN (3) AND DR.CDDOCUMENT=DC.CDDOCUMENT AND PC.FGPERMISSIONTYPE=1 AND DR.CDCATEGORY=PC.CDCATEGORY AND DC.FGUSECATACCESSROLE=1 /* sub */UNION ALL SELECT SRU.CDPERMISSION FROM DCSECRULECONDDOC SRC INNER JOIN DCSECRULECONDUSER SRU ON SRU.CDCONDITION=SRC.CDCONDITION WHERE Dc.FGUSECATACCESSROLE=1 AND SRU.CDUSER IN (1072, -1) AND SRU.CDPERMISSION IN (3) AND SRC.CDDOCUMENT=DC.CDDOCUMENT AND SRU.FGPERMISSIONTYPE=1 GROUP BY SRU.CDPERMISSION, SRC.CDDOCUMENT, SRU.CDUSER, SRU.FGPERMISSIONTYPE) PERM  WHERE NOT EXISTS(SELECT 1 FROM DCUSERPERMISSIONDOC DDOC WHERE DDOC.CDUSER IN (1072, -1) AND DDOC.CDPERMISSION=PERM.CDPERMISSION AND DDOC.CDDOCUMENT=DC.CDDOCUMENT AND DDOC.FGPERMISSIONTYPE=2 AND DC.CDCREATEDBY <> 1072 /* sub */UNION ALL SELECT 1 FROM DCUSERPERMISSIONCATEG PC WHERE PC.CDUSER IN (1072, -1) AND PC.CDPERMISSION=PERM.CDPERMISSION AND DR.CDDOCUMENT=DC.CDDOCUMENT AND PC.FGPERMISSIONTYPE=2 AND DR.CDCATEGORY=PC.CDCATEGORY AND DC.FGUSECATACCESSROLE=1 AND DC.CDCREATEDBY <> 1072 /* sub */UNION ALL SELECT 1 FROM DCSECRULECONDDOC SRC INNER JOIN DCSECRULECONDUSER SRU ON SRU.CDCONDITION=SRC.CDCONDITION WHERE DC.FGUSECATACCESSROLE=1 AND SRU.CDUSER IN (1072, -1) AND SRU.CDPERMISSION=PERM.CDPERMISSION AND SRC.CDDOCUMENT=DC.CDDOCUMENT AND SRU.FGPERMISSIONTYPE=2 AND DC.CDCREATEDBY <> 1072 GROUP BY SRU.CDPERMISSION, SRC.CDDOCUMENT, SRU.CDUSER, SRU.FGPERMISSIONTYPE)) AND CT.FGENABLEVALID=1 AND CT.FGENABLED=1
