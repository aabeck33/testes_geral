SELECT T.FGPARTTYPE, T.FGSTATUS, T.IDTRAIN, T.NMTRAIN, TCONF.IDCONFIGURATION, TCONF.NMCONFIGURATION, C.IDCOURSE, C.NMCOURSE, T.DTPROGSTART, T.DTPROGFINISH, T.VLCOSTPROG AS VLQTPROGCOST, T.QTPARTPROG, T.QTTMTOTPROG, T.DTREALSTART, T.DTREALFINISH, T.CDUSERINST, T.VLCOSTREAL AS VLQTREALCOST, T.QTPARTREAL, T.QTTMTOTREAL, T.FGEFF, T.FGEFFEVAL, T.FGCANCEL, T.FGINVALID, T.CDTRAIN, C.CDCOURSE, T.FGPRESENCELIST, T.DTVALID, CASE WHEN T.DTVALID < '2017-10-06' THEN 1 ELSE 2 END FGVALID, CASE WHEN EXISTS (SELECT 1 FROM ADATTACHMENT ADA INNER JOIN TRTRAINATTACH TRA ON ( TRA.CDATTACHMENT=ADA.CDATTACHMENT) WHERE TRA.CDTRAIN=T.CDTRAIN) THEN 1 ELSE 2 END FGATTACHMENT, CASE WHEN EXISTS (SELECT 1 FROM DCDOCUMENT D INNER JOIN TRTRAINDOC TD ON ( D.CDDOCUMENT=TD.CDDOCUMENT) WHERE TD.CDTRAIN=T.CDTRAIN) THEN 1 ELSE 2 END FGDOCUMENT, CASE WHEN T.FGEFFEVAL=1 THEN CASE WHEN T.FGEFF=1 THEN 1 WHEN T.FGEFF=2 THEN 2 END ELSE 3 END AS FGEFF2, (T.QTTMTOTPROG/60) AS QTTMTOTPROGINHOURS, (T.QTTMTOTREAL/60) AS QTTMTOTREALINHOURS, (CAST(T.QTTMTOTPROG AS NUMERIC)*60000) AS QTTOTPROGHOURS, (CAST(T.QTTMTOTREAL AS NUMERIC)*60000) AS QTTOTREALHOURS, CT.CDGENTYPE AS CDCOURSETYPE, CT.IDGENTYPE AS IDCOURSETYPE, CT.NMGENTYPE AS NMCOURSETYPE,C.IDCOURSE+ ' - ' +C.NMCOURSE AS IDNMCOURSE, CT.IDGENTYPE+ ' - ' +CT.NMGENTYPE AS IDNMTYPECOURSE, TCONF.IDCONFIGURATION+ ' - ' +TCONF.NMCONFIGURATION AS IDNMCONFIGURATION ,CASE WHEN T.FGCANCEL=1 THEN (CAST ('Cancelado' AS VARCHAR(255))) WHEN T.FGINVALID=1 THEN (CAST ('Invalidado' AS VARCHAR(255))) WHEN T.FGSTATUS=1 THEN (CAST ('Planejamento' AS VARCHAR(255))) WHEN T.FGSTATUS=2 THEN (CAST ('Aprovação' AS VARCHAR(255))) WHEN T.FGSTATUS=3 THEN (CAST ('Não aprovado' AS VARCHAR(255))) WHEN T.FGSTATUS=4 THEN (CAST ('Iniciar' AS VARCHAR(255))) WHEN T.FGSTATUS=5 THEN (CAST ('Execução' AS VARCHAR(255))) WHEN T.FGSTATUS=7 THEN (CAST ('Verificação de eficácia' AS VARCHAR(255))) WHEN T.FGSTATUS=8 THEN (CAST ('Encerrado' AS VARCHAR(255))) WHEN T.FGSTATUS=10 THEN (CAST ('Avaliação' AS VARCHAR(255))) END AS IDSTATUS, CASE WHEN TRM.IDTRAININGMETHOD IS NOT NULL THEN CAST(TRM.IDTRAININGMETHOD + ' - ' + TRM.NMTRAININGMETHOD AS VARCHAR(350)) ELSE NULL END AS IDNMTRAININGMETHOD, CASE WHEN T.FGPROFILE <> 1 AND EXISTS (SELECT 1 FROM TRTRAINCONTENT WHERE CDTRAIN=T.CDTRAIN) AND ((  EXISTS  (SELECT 1  FROM TRTRAINUSER  WHERE CDTRAIN=T.CDTRAIN  AND CDUSER=1119) AND ((TR.FGTRAUSRCONTACCESS=1  AND T.FGSTATUS=5  AND (( TR.FGBLOCKEXECONDUE=1 AND TR.DTCONTENTDEADLINE >= CAST(CURRENT_TIMESTAMP AS DATE)) OR TR.FGBLOCKEXECONDUE=2)  AND EXISTS (SELECT 1 FROM TRTRAINUSER TU WHERE TU.FGCONTENTSTATUS=3 AND TU.CDTRAIN=T.CDTRAIN AND TU.CDUSER=1119))  OR (TR.FGTRAUSRCONTACCESS=1  AND TR.FGRETAINCONTACCESS=1  AND (( TR.FGBLOCKEXECONDUE=1 AND TR.DTCONTENTDEADLINE >= CAST(CURRENT_TIMESTAMP AS DATE)) OR TR.FGBLOCKEXECONDUE=2)  AND (( T.FGSTATUS=5 AND EXISTS (SELECT 1 FROM TRTRAINUSER TU WHERE TU.FGCONTENTSTATUS=3 AND TU.CDTRAIN=T.CDTRAIN AND TU.CDUSER=1119)) OR T.FGSTATUS > 5))  OR (TR.FGTRAUSRCONTACCESS=2  AND (SELECT COUNT(1) FROM TRTRAINCONTENT WHERE CDTRAIN=T.CDTRAIN)=1  AND EXISTS (SELECT 1 FROM TRTRAINCONTENT TRTC INNER JOIN TRCONTENT TRC ON (TRC.CDCONTENT=TRTC.CDCONTENT AND TRTC.NRREVISION=TRC.NRREVISION) WHERE TRC.NRTOKEN IS NOT NULL AND TRTC.CDTRAIN=T.CDTRAIN)))) OR EXISTS (SELECT 1 FROM ADTEAMUSER WHERE CDTEAM=T.CDTEAMREAL AND CDUSER=1119) OR ( T.CDTEAMPROG IS NOT NULL AND EXISTS  (SELECT 1  FROM ADTEAMUSER  WHERE CDTEAM=T.CDTEAMPROG  AND CDUSER=1119)) OR ( EXISTS  (SELECT 1  FROM ADTEAMUSER  WHERE CDTEAM= (SELECT VLPARAM  FROM ADPARAMS  WHERE CDISOSYSTEM=153  AND CDPARAM =1)  AND CDUSER=1119)) OR ( T.CDUSERINST=1119)) THEN 1 ELSE 0 END AS FGALLOWACESSCONTENTTRAIN, '<label class=''x-grid-group-header-label-ct''>' + '<div class=''x-grid-group-header-div-flex-ct''>' + '<div class=''x-grid-group-header-div-flex-1''>' + '<div class=''profile x-grid-group-header-div-flex-ct''>' + '<div class=''x-grid-group-header-div-avatar-ct''>' + '<div class=''avatar img-circle''>' + '<img src=''https://sesuite.uniaoquimica.com.br/se/v81739//temp/dXNlcnBob3RvLWh0dHBzOi8vc2VzdWl0ZS51bmlhb3F1aW1pY2EuY29tLmJyL3NlL3Y4MTczOS8=-' + CAST(USU.CDUSER AS VARCHAR(50)) + '.jpg'' id=''imguser_' + CAST(USU.CDUSER AS VARCHAR(50)) + ''' cduser=''' + CAST(USU.CDUSER AS VARCHAR(50)) + ''' title=''Visualizar detalhes do colaborador'' onclick=''createTooltipForGroupColumnUser(this);event.preventDefault();event.stopPropagation();''>' + '</div>' + '</div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-display-flex x-grid-group-header-div-flex-dir-column''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''><label class=''x-grid-group-header-label-title''>Colaborador</label></div>' + '<div class=''x-grid-group-header-div-flex-1''>' + '<span id=''spanuser_' + CAST(USU.CDUSER AS VARCHAR(50)) + ''' cduser=''' + CAST(USU.CDUSER AS VARCHAR(50)) + ''' class=''x-grid-group-header-span-hidden-idnmuser''>' + USU.IDUSER + ' - ' + USU.NMUSER + '</span>' + '<a class=''x-grid-group-header-avatar-user-link'' id=''spanusera_' + CAST(USU.CDUSER AS VARCHAR(50)) + ''' cduser=''' + CAST(USU.CDUSER AS VARCHAR(50)) + ''' title=''Visualizar detalhes do colaborador'' onclick=''createTooltipForGroupColumnUser(this);event.preventDefault();event.stopPropagation();''>' + USU.IDUSER + ' - ' + USU.NMUSER + '</a>' + '</div>' + '</div>' + '</div>' + '</div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-flex-padding-left''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-flex-dir-column''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''><label class=''x-grid-group-header-label-title''>Área</label></div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''>' + '<label class=''x-grid-group-header-label-strong-text x-grid-group-header-label-strong-text-with-a-tag-in-group''>' + AD.IDDEPARTMENT + ' - ' + AD.NMDEPARTMENT + '</label>' + '</div>' + '</div>' + '</div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-flex-padding-left''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-flex-dir-column''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''><label class=''x-grid-group-header-label-title''>Função</label></div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''>' + '<label class=''x-grid-group-header-label-strong-text x-grid-group-header-label-strong-text-with-a-tag-in-group''>' + AP.IDPOSITION + ' - ' + AP.NMPOSITION + '</label>' + '</div>' + '</div>' + '</div>' + '</div>' + '</label>' AS NMUSERINFO, T.FGSTATUS AS FGSTATUSCBK, CASE WHEN TEMPTRAINEXEC.CDMAXTRAINEXEC IS NOT NULL THEN 1 WHEN TEMPTRAINPROG.CDMAXTRAINPROG IS NOT NULL THEN 2 ELSE 3 END AS FGOPENTRAIN, CASE WHEN TEMPTRAINEXEC.CDMAXTRAINEXEC IS NOT NULL THEN TEMPTRAINEXEC.CDMAXTRAINEXEC WHEN TEMPTRAINPROG.CDMAXTRAINPROG IS NOT NULL THEN TEMPTRAINPROG.CDMAXTRAINPROG END AS CDNEXTTRAIN, TU.FGRESULT, TU.VLNOTE, TU.VLFREQ, T.VLCOSTREAL, T.FGCOSTREAL, USU.CDUSER, USU.IDUSER, USU.NMUSER, AD.CDDEPARTMENT, AP.CDPOSITION, AP.IDPOSITION, AP.NMPOSITION, CASE WHEN AP.IDPOSITION IS NOT NULL THEN CAST(AP.IDPOSITION + ' - ' + AP.NMPOSITION AS VARCHAR(310)) ELSE NULL END AS IDNMPOSITION, CASE WHEN AD.IDDEPARTMENT IS NOT NULL THEN CAST (AD.IDDEPARTMENT + ' - ' + AD.NMDEPARTMENT AS VARCHAR(310)) ELSE NULL END AS IDNMDEPARTMENT, AD.IDDEPARTMENT, AD.NMDEPARTMENT, TU.CDTRAINUSER, CASE WHEN TU.FGRESULT=1 THEN (CAST ('Aprovado' AS VARCHAR(255))) WHEN TU.FGRESULT=2 THEN (CAST ('Reprovado' AS VARCHAR(255))) ELSE (CAST ('Não avaliado' AS VARCHAR(255))) END AS NMFGRESULT FROM TRTRAINING T INNER JOIN TRCOURSE C ON (T.CDCOURSE=C.CDCOURSE) INNER JOIN TRCONFIGURATION TCONF ON (T.CDCONFIGURATION=TCONF.CDCONFIGURATION) LEFT OUTER JOIN ADTEAM TEP ON (TEP.CDTEAM=T.CDTEAMPROG) LEFT OUTER JOIN ADTEAM TER ON (TER.CDTEAM=T.CDTEAMREAL) INNER JOIN GNGENTYPE CT ON (C.CDCOURSETYPE=CT.CDGENTYPE AND (CT.CDTYPEROLE IS NULL OR EXISTS (SELECT 1 FROM (SELECT MAX(CHKUSRPERMTYPEROLE.FGPERMISSIONTYPE) AS FGACCESSLIST, CHKUSRPERMTYPEROLE.CDTYPEROLE AS CDTYPEROLE, CHKUSRPERMTYPEROLE.CDUSER FROM (SELECT PM.FGPERMISSIONTYPE, PM.CDUSER, PM.CDTYPEROLE FROM GNUSERPERMTYPEROLE PM WHERE 1=1 AND PM.CDUSER <> -1 AND PM.CDPERMISSION=5 /**/UNION ALL SELECT PM.FGPERMISSIONTYPE, US.CDUSER AS CDUSER, PM.CDTYPEROLE FROM GNUSERPERMTYPEROLE PM, ADUSER US WHERE 1=1 AND PM.CDUSER=-1 AND US.FGUSERENABLED=1 AND PM.CDPERMISSION=5) CHKUSRPERMTYPEROLE GROUP BY CHKUSRPERMTYPEROLE.CDTYPEROLE, CHKUSRPERMTYPEROLE.CDUSER) CHKPERMTYPEROLE WHERE CHKPERMTYPEROLE.FGACCESSLIST=1 AND CHKPERMTYPEROLE.CDTYPEROLE=CT.CDTYPEROLE AND (CHKPERMTYPEROLE.CDUSER=1119 OR 1119=-1)))) LEFT OUTER JOIN TRTRAININGMETHOD TRM ON (TRM.CDTRAININGMETHOD=T.CDTRAININGMETHOD) INNER JOIN TRTRAINUSER TU ON ( T.CDTRAIN=TU.CDTRAIN) INNER JOIN ADUSER USU ON ( TU.CDUSER=USU.CDUSER) INNER JOIN ADDEPARTMENT AD ON ( TU.CDDEPARTMENT=AD.CDDEPARTMENT) INNER JOIN ADPOSITION AP ON ( TU.CDPOSITION=AP.CDPOSITION) INNER JOIN TRCONTENTCONFIG TR ON ( TR.CDCONTENTCONFIG=T.CDCONTENTCONFIG) LEFT OUTER JOIN ( SELECT MAX(TRTRA.CDTRAIN) AS CDMAXTRAINEXEC, TRUSR.CDUSER, TRTRA.CDCOURSE  FROM TRTRAINUSER TRUSR INNER JOIN TRTRAINING TRTRA ON (TRTRA.CDTRAIN=TRUSR.CDTRAIN)  WHERE TRTRA.FGSTATUS > 4  AND TRTRA.FGSTATUS <> 8  AND TRTRA.FGPROFILE <> 1  AND COALESCE(TRTRA.FGCANCEL,2) <> 1  AND COALESCE(TRTRA.FGINVALID,2) <> 1  GROUP BY TRUSR.CDUSER, TRTRA.CDCOURSE) TEMPTRAINEXEC ON ( TEMPTRAINEXEC.CDMAXTRAINEXEC <> T.CDTRAIN AND TEMPTRAINEXEC.CDUSER=USU.CDUSER AND TEMPTRAINEXEC.CDCOURSE=C.CDCOURSE) LEFT OUTER JOIN ( SELECT MAX(TRTRA.CDTRAIN) AS CDMAXTRAINPROG, TRUSR.CDUSER, TRTRA.CDCOURSE  FROM TRTRAINUSER TRUSR INNER JOIN TRTRAINING TRTRA ON (TRTRA.CDTRAIN=TRUSR.CDTRAIN)  WHERE TRTRA.FGSTATUS <= 4  AND TRTRA.FGPROFILE <> 1  AND COALESCE(TRTRA.FGCANCEL,2) <> 1  AND COALESCE(TRTRA.FGINVALID,2) <> 1  GROUP BY TRUSR.CDUSER, TRTRA.CDCOURSE) TEMPTRAINPROG ON ( TEMPTRAINPROG.CDMAXTRAINPROG <> T.CDTRAIN AND TEMPTRAINPROG.CDUSER=USU.CDUSER AND TEMPTRAINPROG.CDCOURSE=C.CDCOURSE) LEFT OUTER JOIN (SELECT DISTINCT Z.CDUSER, Z.CDUSERDATA FROM (/* Pares */ SELECT ADU.CDUSER, ADU2.CDUSER AS CDUSERDATA FROM ADUSER ADU INNER JOIN ADUSER ADU2 ON (( ADU2.CDLEADER IS NOT NULL  AND ADU.CDLEADER=ADU2.CDLEADER) OR  ( ADU2.CDLEADER IS NULL  AND ADU.CDLEADER IS NULL)) INNER JOIN ADPARAMS ADP ON ( ADP.CDPARAM=3 AND ADP.CDISOSYSTEM=153 AND ADP.VLPARAM=1) WHERE ADU.CDUSER <> ADU2.CDUSER AND ADU2.CDUSER=1119  UNION/**/ ALL  /* Lider */ SELECT ADL.CDLEADER AS CDUSER, ADL.CDUSER AS CDUSERDATA FROM ADUSER ADL INNER JOIN ADPARAMS ADP ON ( ADP.CDPARAM=4 AND ADP.CDISOSYSTEM=153 AND ADP.VLPARAM=1) WHERE ADL.CDLEADER IS NOT NULL AND ADL.CDUSER=1119  UNION/**/ ALL  /* Liderados */ SELECT T.CDUSER, 1119 AS CDUSERDATA FROM (SELECT ADU1.CDUSER, ADU0.CDUSER AS CDLEADER, 1 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) WHERE ADU0.CDUSER=1119 UNION/**/ SELECT ADU2.CDUSER, ADU0.CDUSER AS CDLEADER, 2 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) INNER JOIN ADUSER ADU2 ON (ADU2.CDLEADER=ADU1.CDUSER) WHERE ADU0.CDUSER=1119 UNION/**/ SELECT ADU3.CDUSER, ADU0.CDUSER AS CDLEADER, 3 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) INNER JOIN ADUSER ADU2 ON (ADU2.CDLEADER=ADU1.CDUSER) INNER JOIN ADUSER ADU3 ON (ADU3.CDLEADER=ADU2.CDUSER) WHERE ADU0.CDUSER=1119 UNION/**/ SELECT ADU4.CDUSER, ADU0.CDUSER AS CDLEADER, 4 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) INNER JOIN ADUSER ADU2 ON (ADU2.CDLEADER=ADU1.CDUSER) INNER JOIN ADUSER ADU3 ON (ADU3.CDLEADER=ADU2.CDUSER) INNER JOIN ADUSER ADU4 ON (ADU4.CDLEADER=ADU3.CDUSER) WHERE ADU0.CDUSER=1119 UNION/**/ SELECT ADU5.CDUSER, ADU0.CDUSER AS CDLEADER, 5 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) INNER JOIN ADUSER ADU2 ON (ADU2.CDLEADER=ADU1.CDUSER) INNER JOIN ADUSER ADU3 ON (ADU3.CDLEADER=ADU2.CDUSER) INNER JOIN ADUSER ADU4 ON (ADU4.CDLEADER=ADU3.CDUSER) INNER JOIN ADUSER ADU5 ON (ADU5.CDLEADER=ADU4.CDUSER) WHERE ADU0.CDUSER=1119) T INNER JOIN ADPARAMS ADP ON ( ADP.CDPARAM=2 AND ADP.CDISOSYSTEM=153 AND ADP.VLPARAM=1)  UNION/**/ ALL  /* Proprio usuario */ SELECT 1119 AS CDUSER, 1119 AS CDUSERDATA FROM ADMINISTRATION) Z) USERPERM ON (USERPERM.CDUSER=USU.CDUSER AND USERPERM.CDUSERDATA=1119) WHERE T.FGPROFILE <> 1 AND USU.FGUSERENABLED=1 AND (EXISTS (SELECT ADT1.CDUSER FROM ADTEAMUSER ADT1  INNER JOIN ADPARAMS ADP  ON (ADP.CDPARAM=1 AND ADP.CDISOSYSTEM=153 AND ADP.VLPARAM=ADT1.CDTEAM) WHERE ADT1.CDUSER=1119)  OR USERPERM.CDUSER IS NOT NULL)
