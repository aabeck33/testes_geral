SELECT U.CDUSER, U.IDUSER, U.NMUSER, CAST( '<font cduser=' + CAST(U.CDUSER AS VARCHAR(50)) +' title=''View employee details'' onclick=''createTooltipForGroupColumnUser(this);event.preventDefault();event.stopPropagation();''>' + U.IDUSER + ' - ' + U.NMUSER + '</font>' +'<span>'+CAST(AUDP.FGDEFAULTDEPTPOS AS VARCHAR(50))+'</span>'+ '<br><div>'+''+'<label>Dept./Position:</label> ' + D.IDDEPARTMENT + ' - ' + D.NMDEPARTMENT + '/' + P.IDPOSITION + ' - ' + P.NMPOSITION + CASE WHEN AUDP.FGDEFAULTDEPTPOS=1 THEN ' (Default)' ELSE '' END +'</div>' AS VARCHAR(4000)) AS NMUSERINFO2, '<label class=''x-grid-group-header-label-ct''>' + '<div class=''x-grid-group-header-div-flex-ct''>' + '<div class=''x-grid-group-header-div-flex-1''>' + '<div class=''profile x-grid-group-header-div-flex-ct''>' + '<div class=''x-grid-group-header-div-avatar-ct''>' +  '<div class=''avatar img-circle''>' +  '<img src=''https://sesuiteqas.uniaoquimica.com.br/se/v43596//temp/dXNlcnBob3RvLWh0dHBzOi8vc2VzdWl0ZXFhcy51bmlhb3F1aW1pY2EuY29tLmJyL3NlL3Y0MzU5Ni8=-' + CAST(U.CDUSER AS VARCHAR(50)) + '.jpg'' id=''imguser_' + CAST(U.CDUSER AS VARCHAR(50)) + ''' cduser=''' + CAST(U.CDUSER AS VARCHAR(50)) + ''' title=''View employee details'' onclick=''createTooltipForGroupColumnUser(this);event.preventDefault();event.stopPropagation();''>' +  '</div>' + '</div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-display-flex x-grid-group-header-div-flex-dir-column''>' +  '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''><label class=''x-grid-group-header-label-title''>Employee</label></div>' +  '<div class=''x-grid-group-header-div-flex-1''>' +  '<span id=''spanuser_' + CAST(U.CDUSER AS VARCHAR(50)) + ''' cduser=''' + CAST(U.CDUSER AS VARCHAR(50)) + ''' class=''x-grid-group-header-span-hidden-idnmuser''>' + U.IDUSER + ' - ' + U.NMUSER + '</span>' +  '<a class=''x-grid-group-header-avatar-user-link'' id=''spanusera_' + CAST(U.CDUSER AS VARCHAR(50)) + ''' cduser=''' + CAST(U.CDUSER AS VARCHAR(50)) + ''' title=''View employee details'' onclick=''createTooltipForGroupColumnUser(this);event.preventDefault();event.stopPropagation();''>' + U.IDUSER + ' - ' + U.NMUSER + '</a>' +  '</div>' + '</div>' + '</div>' + '</div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-flex-padding-left''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-flex-dir-column''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''><label class=''x-grid-group-header-label-title''>Department</label></div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''>' +  '<label class=''x-grid-group-header-label-strong-text x-grid-group-header-label-strong-text-with-a-tag-in-group''>' + D.IDDEPARTMENT + ' - ' + D.NMDEPARTMENT + '</label>' + '</div>' + '</div>' + '</div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-flex-padding-left''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-flex-dir-column''>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''><label class=''x-grid-group-header-label-title''>Position</label></div>' + '<div class=''x-grid-group-header-div-flex-1 x-grid-group-header-div-label-title-ct''>' +  '<label class=''x-grid-group-header-label-strong-text x-grid-group-header-label-strong-text-with-a-tag-in-group''>' + P.IDPOSITION + ' - ' + P.NMPOSITION + CASE WHEN AUDP.FGDEFAULTDEPTPOS=1 THEN '<i class=''seicon-check'' title=''Default department/position'' style=''font-size:13px; color:#008000''></i>' ELSE '' END + '</label>' + '</div>' + '</div>' + '</div>' + '</div>' + '</label>' AS NMUSERINFO, AUDP.FGDEFAULTDEPTPOS, U.FGUSERENABLED, D.CDDEPARTMENT, D.IDDEPARTMENT, D.NMDEPARTMENT, P.CDPOSITION, P.IDPOSITION, P.NMPOSITION, D.IDDEPARTMENT + ' - ' + D.NMDEPARTMENT AS IDNMDEP, P.IDPOSITION + ' - ' + P.NMPOSITION AS IDNMPOS, U.CDUSER AS QTOPERATORFIELD,0 AS IDHABILITYTYPE , 0 AS IDHABILITY , 0 AS NMHABILITY , 0 AS IDEXPERIENCE, 0 AS NMEXPERIENCE, 0 AS IDINSLEVEL , 0 AS NMINSLEVEL , ADP.CDMAPPING, UC.FGCAPABLE AS FGAPTO, UC.FGREQ , C.CDCOURSE, C.IDCOURSE, C.FGCOURSETYPE, C.NMCOURSE, TRT.FGSTATUS AS FGSTATUSTRAIL, TRT.VLPROGRESS, TRT.VLPROGRESS AS QTPERCTRAIL, GN.CDGENTYPE , GN.CDGENTYPE AS CDCOURSETYPE, GN.IDGENTYPE AS IDCOURSETYPE, GN.IDGENTYPE , GN.NMGENTYPE , T.FGCANCEL, T.FGINVALID , CASE WHEN T.FGCANCEL=1 THEN (CAST ('Cancelled' AS VARCHAR(255))) WHEN T.FGINVALID=1 THEN (CAST ('Invalidated' AS VARCHAR(255))) WHEN T.FGSTATUS=1 THEN (CAST ('Planning' AS VARCHAR(255))) WHEN T.FGSTATUS=2 THEN (CAST ('Planning approval' AS VARCHAR(255))) WHEN T.FGSTATUS=3 THEN (CAST ('Not approved' AS VARCHAR(255))) WHEN T.FGSTATUS=4 THEN (CAST ('Start' AS VARCHAR(255))) WHEN T.FGSTATUS=5 THEN (CAST ('Execution' AS VARCHAR(255))) WHEN T.FGSTATUS=7 THEN (CAST ('Effectiveness verification' AS VARCHAR(255))) WHEN T.FGSTATUS=8 THEN (CAST ('Finished' AS VARCHAR(255))) WHEN T.FGSTATUS=10 THEN (CAST ('Evaluation' AS VARCHAR(255))) END AS NMSTATECAP, UC.DTVALIDITY, UC.CDNEXTTRAIN, UC.FGINHERITED, UC.FGREQUIRESRETRAIN AS FGREQUIRESRETRAINING, CASE WHEN UC.DTVALIDITY < <!%TODAY%> THEN 1 ELSE 2 END AS FGDUETRAIN, T.FGSTATUS AS FGSTATUS, T.FGSTATUS AS FGSTATUSNEXT, TRACTUAL.DTREALSTART AS DTSTARTCAP, TRACTUAL.DTREALFINISH AS DTFINISHCAP, TRACTUAL.FGSTATUS AS FGSTATUSCAP, TRACTUAL.CDTRAIN AS CDTRAINCAP, TRACTUAL.CDHISTCOURSE, C.IDCOURSE + ' - ' + C.NMCOURSE AS IDNMCOURSE, GN.IDGENTYPE + ' - ' + GN.NMGENTYPE AS IDNMGENTYPE, CASE WHEN C.FGCOURSETYPE=2 THEN 'Path' ELSE 'Course' END AS NMCOURSETYPE, CASE WHEN UC.FGINHERITED=1 THEN CAST('Organizational' AS VARCHAR(255)) WHEN UC.FGINHERITED=2 THEN CAST('Individual' AS VARCHAR(255)) END AS NMFGINHERITED, CASE WHEN UC.FGREQ=1 THEN CAST('Required' AS VARCHAR(255)) WHEN UC.FGREQ=2 THEN CAST('Desirable' AS VARCHAR(255)) WHEN UC.FGREQ=3 THEN CAST('Not applicable' AS VARCHAR(255)) END AS NMFGREQ, CASE WHEN UC.FGCAPABLE=1 THEN CAST('Qualified' AS VARCHAR(255)) WHEN UC.FGCAPABLE=2 THEN CAST('Unqualified' AS VARCHAR(255)) WHEN UC.FGCAPABLE=3 THEN CAST('Not evaluated' AS VARCHAR(255)) END AS NMFGCAPABLE FROM TRHISTORICAL HI INNER JOIN ADUSER U ON (U.CDUSER=HI.CDUSER) INNER JOIN TRUSERCOURSE UC ON (UC.CDUSER=U.CDUSER) INNER JOIN TRCOURSE C ON (UC.CDCOURSE=C.CDCOURSE) INNER JOIN GNGENTYPE GN ON (C.CDCOURSETYPE=GN.CDGENTYPE AND (GN.CDTYPEROLE IS NULL OR EXISTS (SELECT 1 FROM (SELECT MAX(CHKUSRPERMTYPEROLE.FGPERMISSIONTYPE) AS FGACCESSLIST, CHKUSRPERMTYPEROLE.CDTYPEROLE AS CDTYPEROLE, CHKUSRPERMTYPEROLE.CDUSER FROM (SELECT PM.FGPERMISSIONTYPE, PM.CDUSER, PM.CDTYPEROLE FROM GNUSERPERMTYPEROLE PM WHERE 1=1 AND PM.CDUSER <> -1 AND PM.CDPERMISSION=5 /* Nao retirar este comentario */UNION ALL SELECT PM.FGPERMISSIONTYPE, US.CDUSER AS CDUSER, PM.CDTYPEROLE FROM GNUSERPERMTYPEROLE PM, ADUSER US WHERE 1=1 AND PM.CDUSER=-1 AND US.FGUSERENABLED=1 AND PM.CDPERMISSION=5) CHKUSRPERMTYPEROLE GROUP BY CHKUSRPERMTYPEROLE.CDTYPEROLE, CHKUSRPERMTYPEROLE.CDUSER) CHKPERMTYPEROLE WHERE CHKPERMTYPEROLE.FGACCESSLIST=1 AND CHKPERMTYPEROLE.CDTYPEROLE=GN.CDTYPEROLE AND (CHKPERMTYPEROLE.CDUSER=<!%CDUSER%> OR <!%CDUSER%>=-1)))) INNER JOIN ADDEPTPOSITION ADP ON (UC.CDMAPPING=ADP.CDMAPPING) LEFT OUTER JOIN TRTRAILEXECUSER TRT ON (TRT.CDUSER=U.CDUSER AND TRT.CDCOURSE=C.CDCOURSE) LEFT OUTER JOIN TRTRAINING T ON (T.CDTRAIN=UC.CDNEXTTRAIN) LEFT OUTER JOIN TRTRAINING TRACTUAL ON (TRACTUAL.CDTRAIN=UC.CDTRAIN) INNER JOIN ADPOSITION P ON (P.CDPOSITION=ADP.CDPOSITION) INNER JOIN ADDEPARTMENT D ON (D.CDDEPARTMENT=ADP.CDDEPARTMENT) INNER JOIN ADUSERDEPTPOS AUDP ON (U.CDUSER=AUDP.CDUSER AND D.CDDEPARTMENT=AUDP.CDDEPARTMENT AND P.CDPOSITION=AUDP.CDPOSITION) LEFT OUTER JOIN (SELECT DISTINCT Z.CDUSER, Z.CDUSERDATA FROM (/* Pares */ SELECT ADU1.CDUSER,  ADU2.CDUSER AS CDUSERDATA FROM ADUSER ADU1  INNER JOIN ADUSER ADU2  ON (ADU1.CDUSER <> ADU2.CDUSER)  INNER JOIN ADUSERDEPTPOS ADUDP1  ON (ADUDP1.CDUSER=ADU1.CDUSER)  INNER JOIN ADUSERDEPTPOS ADUDP2  ON (ADUDP2.CDUSER=ADU2.CDUSER)  INNER JOIN ADPARAMS ADP1  ON (ADP1.CDPARAM=20 AND ADP1.CDISOSYSTEM=153)  INNER JOIN ADPARAMS ADP2  ON (ADP2.CDPARAM=21 AND ADP2.CDISOSYSTEM=153)  INNER JOIN ADPARAMS ADP3  ON (ADP3.CDPARAM=22 AND ADP3.CDISOSYSTEM=153)  INNER JOIN ADPARAMS ADP  ON (ADP.CDPARAM=3 AND ADP.CDISOSYSTEM=153 AND ADP.VLPARAM=1) WHERE 1=1 AND  (( ADP1.VLPARAM=1 AND ADP2.VLPARAM=2 AND ADU2.CDLEADER=ADU1.CDLEADER)  OR (ADP2.VLPARAM=1 AND ADP1.VLPARAM=2 AND ADUDP2.CDDEPARTMENT=ADUDP1.CDDEPARTMENT AND ADUDP2.CDPOSITION=ADUDP1.CDPOSITION)  OR (ADP1.VLPARAM=1 AND ADP2.VLPARAM=1 AND ADP3.VLPARAM=2 AND (( ADU2.CDLEADER=ADU1.CDLEADER) OR  ( ADUDP2.CDDEPARTMENT=ADUDP1.CDDEPARTMENT  AND ADUDP2.CDPOSITION=ADUDP1.CDPOSITION)))  OR (ADP1.VLPARAM=1 AND ADP2.VLPARAM=1 AND ADP3.VLPARAM=1 AND (( ADU2.CDLEADER=ADU1.CDLEADER) AND  ( ADUDP2.CDDEPARTMENT=ADUDP1.CDDEPARTMENT  AND ADUDP2.CDPOSITION=ADUDP1.CDPOSITION)))) AND ADU2.CDUSER=<!%CDUSER%> GROUP BY ADU1.CDUSER,  ADU2.CDUSER  UNION/**/ ALL  /* Lider */ SELECT ADL.CDLEADER AS CDUSER, ADL.CDUSER AS CDUSERDATA FROM ADUSER ADL INNER JOIN ADPARAMS ADP ON ( ADP.CDPARAM=4 AND ADP.CDISOSYSTEM=153 AND ADP.VLPARAM=1) WHERE ADL.CDLEADER IS NOT NULL AND ADL.CDUSER=<!%CDUSER%>  UNION/**/ ALL  /* Liderados */ SELECT T.CDUSER, <!%CDUSER%> AS CDUSERDATA FROM (SELECT ADU1.CDUSER, ADU0.CDUSER AS CDLEADER, 1 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) WHERE ADU0.CDUSER=<!%CDUSER%> UNION/**/ SELECT ADU2.CDUSER, ADU0.CDUSER AS CDLEADER, 2 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) INNER JOIN ADUSER ADU2 ON (ADU2.CDLEADER=ADU1.CDUSER) WHERE ADU0.CDUSER=<!%CDUSER%> UNION/**/ SELECT ADU3.CDUSER, ADU0.CDUSER AS CDLEADER, 3 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) INNER JOIN ADUSER ADU2 ON (ADU2.CDLEADER=ADU1.CDUSER) INNER JOIN ADUSER ADU3 ON (ADU3.CDLEADER=ADU2.CDUSER) WHERE ADU0.CDUSER=<!%CDUSER%> UNION/**/ SELECT ADU4.CDUSER, ADU0.CDUSER AS CDLEADER, 4 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) INNER JOIN ADUSER ADU2 ON (ADU2.CDLEADER=ADU1.CDUSER) INNER JOIN ADUSER ADU3 ON (ADU3.CDLEADER=ADU2.CDUSER) INNER JOIN ADUSER ADU4 ON (ADU4.CDLEADER=ADU3.CDUSER) WHERE ADU0.CDUSER=<!%CDUSER%> UNION/**/ SELECT ADU5.CDUSER, ADU0.CDUSER AS CDLEADER, 5 AS NRLEVEL FROM ADUSER ADU0 INNER JOIN ADUSER ADU1 ON (ADU1.CDLEADER=ADU0.CDUSER) INNER JOIN ADUSER ADU2 ON (ADU2.CDLEADER=ADU1.CDUSER) INNER JOIN ADUSER ADU3 ON (ADU3.CDLEADER=ADU2.CDUSER) INNER JOIN ADUSER ADU4 ON (ADU4.CDLEADER=ADU3.CDUSER) INNER JOIN ADUSER ADU5 ON (ADU5.CDLEADER=ADU4.CDUSER) WHERE ADU0.CDUSER=<!%CDUSER%>) T INNER JOIN ADPARAMS ADP ON ( ADP.CDPARAM=2 AND ADP.CDISOSYSTEM=153 AND ADP.VLPARAM=1)  UNION/**/ ALL  /* Proprio usuario */ SELECT <!%CDUSER%> AS CDUSER, <!%CDUSER%> AS CDUSERDATA FROM ADMINISTRATION) Z) USERPERM ON (USERPERM.CDUSER=U.CDUSER AND USERPERM.CDUSERDATA=<!%CDUSER%>) WHERE 1=1 AND U.FGUSERENABLED=1 AND EXISTS (SELECT 1 FROM ADUSERDEPTPOS ADUDPOS WHERE ADUDPOS.FGDEFAULTDEPTPOS=1 AND ADUDPOS.CDUSER=U.CDUSER AND ADUDPOS.CDDEPARTMENT=D.CDDEPARTMENT AND ADUDPOS.CDPOSITION=P.CDPOSITION) AND (EXISTS (SELECT ADT1.CDUSER FROM ADTEAMUSER ADT1  INNER JOIN ADPARAMS ADP  ON (ADP.CDPARAM=1 AND ADP.CDISOSYSTEM=153 AND ADP.VLPARAM=ADT1.CDTEAM) WHERE ADT1.CDUSER=<!%CDUSER%>)  OR USERPERM.CDUSER IS NOT NULL)
